<template>
  <el-scrollbar class="character-card-editor-scrollbar">
    <div class="content-panel-body">
      <CharacterCardButtons
        :characterName="form.chineseName"
        @saveCharacterCard="saveCharacterCard" @loadCharacterCard="loadCharacterCard"
        @resetForm="resetForm" @copyToClipboard="copyToClipboard"
        @importFromClipboard="(data) => importFromClipboard(data)" />
      <el-form :model="form" label-position="top" ref="characterFormRef" class="character-card-editor-form">
        <section class="form-section">
          <h3 class="form-section-title">
            <Icon icon="ph:info-duotone" class="form-section-icon" />基本信息
          </h3>
          <div class="form-section-content">
            <div class="form-row-responsive">
              <div class="form-group-responsive">
                <label class="form-label">中文名</label>
                <el-input v-model="form.chineseName" placeholder="请输入中文名" />
              </div>
              <div class="form-group-responsive">
                <label class="form-label">日文名</label>
                <el-input v-model="form.japaneseName" disabled placeholder="逻辑未处理" />
              </div>
            </div>
            <div class="form-row-responsive">
              <div class="form-group-responsive">
                <label class="form-label">性别</label>
                <el-select v-model="form.gender" placeholder="请选择性别" class="form-full-width">
                  <el-option label="女性" value="female" />
                  <el-option label="男性" value="male" />
                  <el-option label="秀吉（伪娘、正太）" value="秀吉（伪娘、正太）" />
                  <el-option label="武装直升机" value="helicopter" />
                  <el-option label="牢大" value="Prison_big" />
                  <el-option label="永雏塔菲" value="tiffany" />
                  <el-option label="赛马娘" value="horse" />
                  <el-option label="沃尔玛购物袋" value="walmartShopingBag" />
                  <el-option label="其他(自定义)" value="other" />
                </el-select>
                <el-input v-if="form.gender === 'other'" v-model="form.customGender" placeholder="请输入角色的性别（other）"
                  style="margin-top: 10px;" />
              </div>
              <div class="form-group-responsive">
                <label class="form-label">年龄</label>
                <el-input-number v-model="form.age" controls-position="right" :min="-Infinity" :max="Infinity"
                  :precision="0" class="form-full-width" />
                <p class="form-help-text">限制为数字，请勿输入其他字段</p>
              </div>
            </div>
            <div>
              <label class="form-label">身份</label>
              <el-input v-model="form.identity" type="textarea" :rows="5" placeholder="请输入身份 · 一行一条" />
            </div>
          </div>
        </section>

        <section class="form-section">
          <h3 class="form-section-title">
            <Icon icon="ph:book-open-duotone" class="form-section-icon" />背景故事
          </h3>
          <div class="form-section-content">
            <div>
              <label class="form-label">背景故事</label>
              <el-input v-model="form.background" type="textarea" :rows="6" placeholder="请输入背景故事（每行一条）" />
            </div>
            <div style="margin-top: 1rem;">
              <div class="title-Btn" style="display: flex;align-items: center;justify-content: space-between;">
                <label class="form-label">MBTI性格</label>
                <el-button type="primary" @click="validateMBTI">
                  <Icon icon="material-symbols:question-exchange" width="18" height="18" style="margin-right: 4px;" />验证
                </el-button>
              </div>
              <p class="form-help-text">必须是有效的MBTI数值或者是 none </p>
              <el-input v-model="form.mbti" placeholder="请输入MBTI性格" />
            </div>
          </div>
        </section>

        <el-tabs v-model="activeTab" class="settings-tabs">
          <el-tab-pane label="外观与服装" name="appearance">
            <AppearanceAndAttireTab :form="form" @addAttire="addAttire" @removeAttire="removeAttire"
              @exportAttires="exportAttires" v-model:attires="form.attires" />
          </el-tab-pane>
          <el-tab-pane label="角色特质" name="traits">
            <TraitsTab :form="form" @addTrait="addTrait" @removeTrait="removeTrait" @exportTraits="exportTraits"
              v-model:traits="form.traits" @addRelationship="addRelationship" @removeRelationship="removeRelationship"
              @exportRelationships="exportRelationships" v-model:relationships="form.relationships" @addSkill="addSkill"
              @removeSkill="removeSkill" @exportSkills="exportSkills" v-model:skills="form.skills" />
          </el-tab-pane>
          <el-tab-pane label="日常与笔记" name="notes">
            <DailyAndNotesTab :form="form" @update:form-likes="form.likes = $event"
              @update:form-dislikes="form.dislikes = $event" @addNote="addNote" @removeNote="removeNote"
              v-model:notes="form.notes" />
          </el-tab-pane>
        </el-tabs>
      </el-form>
    </div>
  </el-scrollbar>
</template>

<script setup lang="ts">
import { ref, watch, nextTick } from 'vue';
import { ElScrollbar, ElForm, ElInput, ElSelect, ElOption, ElInputNumber, ElTabs, ElTabPane, ElButton, ElMessageBox } from 'element-plus';
import { Icon } from '@iconify/vue';
import CharacterCardButtons from './charcard/CharacterCardButtons.vue';
import AppearanceAndAttireTab from './charcard/tabs/AppearanceAndAttireTab.vue';
import TraitsTab from './charcard/tabs/TraitsTab.vue';
import DailyAndNotesTab from './charcard/tabs/DailyAndNotesTab.vue';
import type { CharacterCard } from '../types/character';
import { useCardDataHandler } from '../composables/characterCard/useCardDataHandler';
import { useCardSections } from '../composables/characterCard/useCardSections';
import { useCharacterCardLifecycle } from '../composables/characterCard/useCharacterCardLifecycle';

const props = defineProps<{
  character: CharacterCard;
}>();

const emit = defineEmits<{
  (e: 'update:character', character: CharacterCard): void;
}>();

const activeTab = ref('appearance');
const characterFormRef = ref<InstanceType<typeof ElForm> | null>(null);

const form = ref({ ...props.character });

// 监听props变化，同步到本地form
watch(() => props.character, (newCharacter) => {
  if (newCharacter && newCharacter.id !== form.value.id) {
    // 只在角色ID不同时才更新，避免循环更新
    form.value = { ...newCharacter };
  }
}, { deep: true, immediate: true });

// 监听本地form变化，同步到父组件
watch(form, (updatedCharacter) => {
  nextTick(() => {
    emit('update:character', { ...updatedCharacter });
  });
}, { deep: true });

const {
  saveCharacterCard,
  loadCharacterCard,
  resetForm,
  copyToClipboard,
  importFromClipboard,
  processLoadedData,
} = useCardDataHandler(form);

const {
  addTrait,
  removeTrait,
  addSkill,
  removeSkill,
  addRelationship,
  removeRelationship,
  addNote,
  removeNote,
  addAttire,
  removeAttire,
  exportAttires,
  exportSkills,
  exportTraits,
  exportRelationships,
} = useCardSections(form);

useCharacterCardLifecycle(form, processLoadedData);

// MBTI Validation
const isValidMBTI = (mbti: string) => {
  return mbti.toLowerCase() === 'none' || /^[EI][SN][TF][JP]$/i.test(mbti);
};

interface MBTIDescriptions {
  [key: string]: string;
}

const mbtiDescriptions: MBTIDescriptions = {
  INTP: '逻辑学家',
  INTJ: '建筑师',
  ENTP: '辩论家',
  ENTJ: '指挥官',
  INFP: '调停者',
  INFJ: '提倡者',
  ENFJ: '主人公',
  ENFP: '竞选者',
  ISTJ: '物流师',
  ISFJ: '守卫者',
  ESTJ: '总经理',
  ESFJ: '执政官',
  ISTP: '鉴赏家',
  ISFP: '探险家',
  ESTP: '企业家',
  ESFP: '表演者',
  none: '未指定'
};

const validateMBTI = () => {
  if (!form.value.mbti) {
    ElMessageBox.alert('请输入MBTI类型', '警告');
    return;
  }
  const type = form.value.mbti.toUpperCase();
  if (isValidMBTI(form.value.mbti)) {
    const description = mbtiDescriptions[type] || mbtiDescriptions['none'];
    ElMessageBox.alert(`MBTI格式正确，类型：${type} - ${description}`, '正确');
  } else {
    ElMessageBox.alert(`MBTI格式无效：${type}，请输入4个字母的组合或"none"`, '不合规');
  }
};

defineExpose({
  saveCharacterCard,
  loadCharacterCard,
  resetForm,
  addAttire,
  removeAttire,
  exportAttires,
  copyToClipboard,
  importFromClipboard,
  exportSkills,
  exportTraits,
  exportRelationships
});
</script>

<style scoped>
/* 主容器样式 - 采用 worldbook 设计语言 */
.character-card-editor-scrollbar {
  height: 100vh;
}

.content-panel-body {
  background: var(--el-bg-color);
  border-radius: 4px;
  border: 1px solid var(--el-border-color-lighter);
  padding: 16px;
}

/* 表单区块样式 - 统一 worldbook 风格 */
.character-card-editor-form .form-section {
  margin-bottom: 24px;
  padding: 16px;
  background: var(--el-fill-color-extra-light);
  border-radius: 4px;
  border: 1px solid var(--el-border-color-extra-light);
}

.character-card-editor-form .form-section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 600;
  color: var(--el-text-color-primary);
  margin: 0 0 16px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--el-border-color-lighter);
}

.character-card-editor-form .form-section-icon {
  font-size: 18px;
  color: #409eff;
}

.character-card-editor-form .form-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--el-text-color-primary);
  margin-bottom: 4px;
  display: block;
}

/* 响应式布局 - 统一 worldbook 网格系统 */
.form-row-responsive {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

@media (min-width: 768px) {
  .form-row-responsive {
    flex-direction: row;
    gap: 24px;
  }
}

.form-group-responsive {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
}

.form-full-width {
  width: 100%;
}

.form-help-text {
  font-size: 12px;
  color: var(--el-text-color-regular);
  margin: 4px 0 0 0;
  line-height: 1.4;
}

/* 标签页样式优化 */
.settings-tabs {
  margin-top: 20px;
}

:deep(.el-tabs__header) {
  margin: 0 0 20px;
}

:deep(.el-tabs__item) {
  font-size: 14px;
  font-weight: 500;
  padding: 0 16px;
}

:deep(.el-tabs__item.is-active) {
  color: var(--el-color-primary);
  font-weight: 600;
}

:deep(.el-tabs__active-bar) {
  background-color: var(--el-color-primary);
}

:deep(.el-tabs__content) {
  padding-top: 0;
}
</style>
