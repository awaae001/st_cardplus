# 需求文档：MUV 动态模板 EJS 编辑器

## 1. 项目背景与目标

### 1.1. 问题陈述 (The Problem)

在当前的工作流中，为了在 SillyTavern 中实现动态的角色行为（例如，角色的态度根据好感度变化），用户需要手动编写一种特殊的代码模板。这种模板混合了 EJS (一种JavaScript模板语言) 和 YAML (一种数据格式)，结构复杂且对非程序员极不友好。

**手动编写的痛点：**
*   **易出错**: 语法要求严格，括号、引号、缩进的微小错误都可能导致整个模板失效。
*   **学习成本高**: 需要同时理解 EJS 的逻辑、YAML 的格式以及 MUV 系统的变量规则。
*   **效率低下**: 创建和修改模板耗时耗力，难以快速迭代和调试。
*   **可读性差**: 大段的代码和文本混合在一起，难以快速理解一个模板的整体逻辑。

**一个手动编写的例子：**
```ejs
<%_ if (getvar('stat_data.理.好感度[0]') < 20) { _%>
疏远警惕:
  行为指导:
    - "与<user>的接触几乎仅限于寒暄"
    - "在班级活动中故意保持距离"
  变化倾向:
    - "开始在<user>读完日记后尝试和<user>聊天"
<%_ } else if (getvar('stat_data.理.好感度[0]') < 40) { _%>
谨慎靠近:
  行为指导:
    - "主动在对方读完日记中提问感想"
  变化倾向:
    - "日记中开始出现一些童年的回忆片段"
<%_ } _%>
```

### 1.2. 项目目标 (The Solution)

本项目旨在开发一个**可视化的 EJS 模板编辑器**，将上述复杂的编码过程转变为直观的图形界面操作。

**核心目标：**
*   **降低门槛**: 即便用户不懂代码，也能通过点击和填写来创建功能完善的动态模板。
*   **提升效率**: 自动化代码生成，让模板的创建和修改过程变得快速、简单。
*   **保证质量**: 由程序生成代码，从根本上避免手动编写时可能出现的语法错误。
*   **提供即时反馈**: 用户在界面上的每一步操作都能实时预览到最终生成的代码，并能快速测试其逻辑。

最终，用户将通过一个“所见即所得”的工具，轻松完成动态模板的配置。

## 2. 核心概念解析

为了理解编辑器的功能，开发者需要了解以下三个核心概念：

*   **变量 (Variable)**:
    *   **它是什么？** 一个存储在系统某处、可以随故事发展而动态改变的数值。最常见的例子是角色的“好感度”，它会从 0 慢慢增长到 100。
    *   **如何定位？** 通过一个唯一的路径，如 `stat_data.理.好感度`。
    *   **编辑器的作用**: 编辑器需要知道使用哪个变量来驱动模板。

*   **阶段 (Stage)**:
    *   **它是什么？** 将一个连续的变量（如 0-100 的好感度）划分为几个有意义的、离散的区间。
    *   **举例**:
        *   好感度 `0-19`  ->  阶段名: `陌生`
        *   好感度 `20-39` ->  阶段名: `熟悉`
        *   好感度 `40-100`->  阶段名: `信赖`
    *   **编辑器的作用**: 编辑器需要让用户能够方便地定义这些阶段及其对应的数值范围。

*   **模板 (Template)**:
    *   **它是什么？** 最终产物。是一段可以被系统执行的代码。
    *   **它做什么？** 这段代码的唯一功能是：获取**变量**的当前值，判断这个值属于哪个**阶段**，然后将该阶段对应的**内容**（通常是一段 YAML 格式的角色描述）输出。
    *   **编辑器的作用**: 编辑器的核心任务就是根据用户的配置，自动生成这段模板代码。

## 3. 功能需求

### 3.1. 关联变量定义
*   **用户故事**: “作为模板创建者，我希望能轻松指定这个模板是由哪个变量控制的，并给它起一个好记的名字。”
*   **需求**:
    1.  提供一个输入框，用于填写变量的完整路径 (e.g., `stat_data.理.好感度`)。
    2.  提供一个输入框，用于为该变量设置一个在编辑器内部显示的“别名” (e.g., `好感度`)，以增强可读性。

### 3.2. 阶段划分与管理
*   **用户故事**: “我希望能自由地将变量的数值范围划分成任意多个阶段，并为每个阶段命名。”
*   **需求**:
    1.  提供一个阶段列表，用户可以动态地**添加**新阶段或**删除**已有阶段。
    2.  对于每个阶段，用户必须能定义：
        *   **阶段名称** (e.g., `信赖`)。
        *   **数值范围** (e.g., `40-100`)。范围定义需支持 `<`, `<=`, `==`, `>`, `>=`, 以及区间 (e.g., `20-39`)。
    3.  用户应能方便地**编辑**已创建的阶段信息。

### 3.3. 阶段内容编辑
*   **用户故事**: “当我定义好一个阶段后，我希望能为这个阶段填写具体的角色描述，并且格式不受限制。”
*   **需求**:
    1.  提供一个**自由文本编辑区**。
    2.  当用户在阶段列表中选中某个阶段时，该编辑区会加载此阶段对应的内容。
    3.  编辑器应提供 **YAML 语法高亮**，以辅助用户编写。
    4.  用户在此区域编写的内容将被原样嵌入到最终生成的 EJS 代码中。

### 3.4. 实时预览
*   **用户故事**: “我希望在我配置的时候，能立刻看到生成的代码是什么样子，以确保我的操作是正确的。”
*   **需求**:
    1.  界面上需有一个区域，**实时显示**根据当前所有配置生成的完整 EJS 代码。
    2.  代码预览区应有良好的**语法高亮**和**格式化**，便于阅读。
    3.  提供一个**一键复制**按钮，将预览区的全部代码复制到剪贴板。

### 3.5. 模拟运行与测试
*   **用户故事**: “在完成配置后，我想快速测试一下我的阶段划分是否正确，比如输入好感度为 35，我期望它能告诉我这属于‘熟悉’阶段。”
*   **需求**:
    1.  提供一个**模拟运行**面板。
    2.  面板中有一个数字输入框，用户可以输入一个模拟的变量值。
    3.  点击“测试”按钮后，系统应立即计算并**显示出匹配到的阶段名称**。
    4.  (可选增强) 在代码预览区中，**高亮**显示匹配到的 `if` 逻辑块。

## 4. 界面设计与技术规格

### 4.1. UI 布局
采用左右分栏经典布局：
*   **左栏 (配置区)**: 包含关联变量、阶段列表、内容编辑器。
*   **右栏 (预览与测试区)**: 包含模拟运行面板和代码预览。

### 4.2. 技术栈
*   **框架**: Vue 3
*   **UI 库**: Element Plus
*   **状态管理**: Pinia
*   **代码编辑器组件**: Monaco Editor

## 5. 输入输出示例

**用户在编辑器中的配置 (输入):**

*   **变量路径**: `stat_data.理.好感度`
*   **变量别名**: `好感度`
*   **阶段 1**:
    *   名称: `疏远`
    *   范围: `< 20`
    *   内容:
        ```yaml
        疏远:
          行为: "冷淡"
        ```
*   **阶段 2**:
    *   名称: `熟悉`
    *   范围: `20-39`
    *   内容:
        ```yaml
        熟悉:
          行为: "友好"
        ```

**编辑器生成的代码 (输出):**

```ejs
<%_ const 好感度 = getvar('stat_data.理.好感度'); _%>
<%_ if (好感度 < 20) { _%>
疏远:
  行为: "冷淡"
<%_ } else if (好感度 >= 20 && 好感度 < 40) { _%>
熟悉:
  行为: "友好"
<%_ } _%>