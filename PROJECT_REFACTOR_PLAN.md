**st_cardplus 项目重构计划**

**一、总体目标**

1.  **提高代码复用率：** 提取通用组件和逻辑，减少重复代码。
2.  **实现项目模块化：** 将项目按功能或领域划分为独立的模块，降低耦合度。
3.  **优化代码结构：** 使代码更易于理解、维护和扩展。
4.  **全面添加中文注释：** 提高代码可读性。
5.  **编写详细中文开发文档：** 方便团队协作和后续维护。

**二、核心原则**

- **循序渐进：** 分阶段实施，每个阶段都有明确的交付物和验证点。
- **测试保障：** 在重构过程中，逐步补充和完善单元测试、组件测试，确保功能稳定。
- **版本控制：** 所有重构工作在专门的 Git 分支（例如 `refactor/project-makeover`）上进行，定期合并到主开发分支，确保代码安全和可追溯。
- **文档同步：** 代码的修改与文档的编写保持同步，确保文档的时效性。
- **团队协作：** 若多人参与，需明确分工，并定期进行代码审查（Code Review）。

**三、重构阶段与任务详情**

**阶段零：准备与分析 (预计 1-2 周)**

1.  **1. 深入代码审查与评估：**

    - **任务：** 详细阅读现有项目代码，特别是 `src/components/` 目录下的所有组件（如 `CharacterCardEditor.vue`, `CharacterCradOutput.vue`, `WorldBookEditor.vue` 等及其子组件 `charcard/`, `CharOutput/`），以及 `src/utils/` 和 `src/stores/`。
    - **目标：**
      - 识别代码重复区域（UI、逻辑）。
      - 找出过大、职责不清的组件。
      - 分析模块间的耦合情况。
      - 评估现有状态管理（Pinia store `appSettings.ts`）的合理性。
    - **产出：**
      - 《代码问题与风险点分析报告》。
      - 《潜在可复用组件与逻辑清单》。

2.  **2. 确定模块划分方案与新项目结构：**

    - **任务：** 基于功能（如角色卡编辑、角色卡输出、世界书、工具箱等）和分层（UI、业务逻辑、数据、工具）思想，设计新的模块化方案。
    - **目标：** 定义清晰的模块边界和职责。
    - **初步建议结构：**
      ```
      src/
      ├── assets/              // 静态资源
      ├── modules/             // 核心业务模块
      │   ├── character/       // 角色卡模块
      │   │   ├── components/  // 角色卡相关组件 (细分 editor, output, shared)
      │   │   ├── composables/ // 角色卡相关组合式函数 (Vue 3 Composition API)
      │   │   ├── store/       // 角色卡 Pinia store
      │   │   ├── types/       // 角色卡相关 TypeScript 类型定义
      │   │   └── services/    // 角色卡相关业务逻辑服务 (如果复杂)
      │   ├── world/           // 世界书模块 (类似character结构)
      │   │   ├── components/
      │   │   ├── composables/
      │   │   ├── store/
      │   │   ├── types/
      │   │   └── services/
      │   ├── toolbox/         // 工具箱模块
      │   │   ├── components/  // 各工具组件 (JsonFormatter, RegexEditorPage)
      │   │   ├── utils/       // 工具箱特有工具函数
      │   │   └── types/
      │   └── core/            // 核心/共享模块 (可选，或分散到各模块的shared)
      │       ├── components/  // 全局通用基础组件 (如 Button, Input, Modal)
      │       ├── composables/ // 全局通用组合式函数
      │       ├── store/       // 全局应用设置 Pinia store (如 appSettings.ts 可移至此)
      │       ├── types/       // 全局通用类型定义
      │       └── utils/       // 全局通用工具函数
      ├── pages/               // 页面级组件 (视图)
      ├── router/              // 路由配置
      ├── styles/              // 全局样式 (style.css 可移至此并拆分)
      ├── main.ts              // 应用入口
      ├── App.vue              // 根组件
      └── vite-env.d.ts
      ```
    - **产出：**
      - 《项目模块划分方案文档》。
      - 《新项目目录结构规范》。

3.  **3. 制定编码与注释规范：**

    - **任务：** 统一代码风格、命名约定、注释标准。
    - **目标：** 提高代码一致性和可维护性。
    - **方法：**
      - 配置并强制使用 ESLint 和 Prettier。
      - 定义组件、变量、函数、模块的中文命名约定（若适用）和英文命名规范。
      - 规定中文注释的格式和详尽程度（如 JSDoc/TSDoc 风格）。
    - **产出：**
      - 《编码规范文档》。
      - 《中文注释规范文档》。
      - ESLint 和 Prettier 配置文件。

4.  **4. 搭建基础环境与工具：**
    - **任务：** 确保开发环境支持重构工作。
    - **目标：** 为后续阶段提供支持。
    - **方法：**
      - 创建 Git 重构分支。
      - 配置路径别名（Vite `resolve.alias`）以适应新的目录结构。
      - 引入或确认测试框架（如 Vitest）。
    - **产出：** 配置好的开发环境。

**阶段一：基础层与共享模块重构 (预计 2-3 周)**

1.  **1. 提取和优化通用工具函数：**

    - **任务：** 整理 `src/utils/` 下的函数，将通用的、与具体业务无关的函数提取到 `src/modules/core/utils/` (或新的 `src/utils/` 顶级目录)。
    - **目标：** 建立可复用的工具函数库。
    - **方法：**
      - 按功能分类（如 `domUtils.ts`, `stringUtils.ts`, `localStorageUtils.ts` 等）。
      - 为每个函数添加详细的中文注释和类型定义。
      - 编写单元测试。
    - **产出：** 优化后的工具函数库，附带中文注释和单元测试。

2.  **2. 重构状态管理 (Pinia Stores)：**

    - **任务：** 根据新的模块划分，拆分或重组 Pinia store。
    - **目标：** 使状态管理更内聚，职责更清晰。
    - **方法：**
      - 将 `appSettings.ts` 中与特定模块相关的状态移至对应模块的 store (如 `src/modules/character/store/characterSettings.ts`)。
      - 全局应用设置保留在 `src/modules/core/store/appSettings.ts`。
      - 确保每个 store 的 state, getters, actions 职责单一，并添加中文注释。
    - **产出：** 模块化的 Pinia store 结构，附带中文注释。

3.  **3. 建立共享 UI 组件库：**

    - **任务：** 从现有组件中识别并提取可全局复用的基础 UI 组件（如按钮、输入框、弹窗、布局元素等）。
    - **目标：** 减少 UI 重复，统一视觉风格。
    - **方法：**
      - 创建 `src/modules/core/components/` (或 `src/components/common/`) 目录。
      - 将提取的组件参数化，通过 props 和 events 定义接口。
      - 添加中文注释和使用示例。
    - **产出：** 共享 UI 组件库，附带中文注释和文档。

4.  **4. 定义核心 TypeScript 类型：**
    - **任务：** 为项目中核心的数据结构（如角色卡数据、世界书条目等）定义明确的 TypeScript 接口或类型。
    - **目标：** 增强代码类型安全，提高可维护性。
    - **方法：**
      - 在各模块的 `types/` 目录下或全局 `src/modules/core/types/` 中创建类型定义文件。
      - 在代码中尽可能使用这些类型。
    - **产出：** 清晰的 TypeScript 类型定义文件。

**阶段二：核心业务模块重构 (预计 4-6 周，可按模块并行)**

- **通用策略：**
  - **自下而上：** 先重构或创建模块内部可复用的子组件和组合式函数。
  - **充分利用 Vue 3 Composition API：** 将逻辑抽取到 `composables/` 中，提高逻辑复用性和组件简洁性。
  - **组件拆分：** 将大型复杂组件拆分为更小、更专注的单一职责组件。

1.  **1. 角色卡模块 (`src/modules/character`) 重构：**

    - **任务：** 重构 `CharacterCardEditor.vue`, `CharacterCradOutput.vue` 及其子组件 (`src/components/charcard/`, `src/components/CharOutput/`)。
    - **目标：** 实现角色卡编辑和展示功能的高度模块化和复用。
    - **方法：**
      - 分析 `charcard` 和 `CharOutput` 下的组件，识别哪些是编辑特有、输出特有、或两者可共享的。
      - 将共享的表单元素、展示单元等提取为 `src/modules/character/components/shared/` 下的组件。
      - 编辑相关的组件放入 `src/modules/character/components/editor/`。
      - 输出相关的组件放入 `src/modules/character/components/output/`。
      - 角色卡相关的业务逻辑、数据处理逻辑封装到 `src/modules/character/composables/`。
      - 更新 `CardPage.vue` 和 `CardOutput.vue` 页面，使其引用新的模块化组件。
      - 为所有新组件和逻辑添加中文注释。
    - **产出：** 结构清晰、高复用性的角色卡模块代码，附带中文注释。

2.  **2. 世界书模块 (`src/modules/world`) 重构：**

    - **任务：** 重构 `WorldBookEditor.vue`, `WorldEditor.vue` 及其相关逻辑。
    - **目标：** 实现世界书功能的模块化。
    - **方法：** 参照角色卡模块的重构思路，建立 `components/`, `composables/`, `store/`, `types/` 等子目录，进行拆分和优化。添加中文注释。
    - **产出：** 结构清晰的世界书模块代码，附带中文注释。

3.  **3. 工具箱模块 (`src/modules/toolbox`) 重构：**

    - **任务：** 整理 `src/components/toolsbox/` 下的工具组件。
    - **目标：** 使每个工具功能独立，易于扩展。
    - **方法：**
      - 将 `JsonFormatter.vue`, `RegexEditorPage.vue`, `separator.vue` 等移至 `src/modules/toolbox/components/` 下，可根据工具复杂性再分子目录。
      - 工具特定的逻辑封装到各自的 `composables` 或 `utils` 中。
      - 添加中文注释。
    - **产出：** 模块化的工具箱代码，附带中文注释。

4.  **4. 页面 (`src/pages`) 和路由 (`src/router`) 调整：**
    - **任务：** 更新页面组件，使其仅作为视图容器，串联来自各模块的组件和逻辑。调整路由配置以匹配新的组件路径。
    - **目标：** 保持页面层轻量。
    - **产出：** 更新后的页面组件和路由配置。

**阶段三：代码注释完善与文档编写 (与阶段二并行或紧随其后，预计 2-4 周)**

1.  **1. 全面审查和补充中文注释：**

    - **任务：** 确保项目中所有模块、组件、函数、重要变量、复杂逻辑块都有清晰、规范的中文注释。
    - **目标：** 代码即文档，提升可读性。
    - **方法：** 遵循阶段零制定的《中文注释规范文档》。
    - **产出：** 注释覆盖率达到 90%以上的代码库。

2.  **2. 编写详细中文开发文档：**
    - **任务：** 创建一份全面的项目开发指南。
    - **目标：** 降低新成员上手门槛，方便长期维护。
    - **文档结构建议 (存放于项目根目录 `docs/` 或使用 VitePress/VuePress 等工具)：**
      - **`README.md` (项目根目录):** 项目简介、快速开始、主要特性。
      - **`docs/01-introduction.md`:** 项目背景、目标用户、技术栈选型。
      - **`docs/02-getting-started.md`:** 开发环境搭建、依赖安装、启动命令、构建与打包。
      - **`docs/03-architecture.md`:**
        - 项目整体架构图。
        - 模块划分详解 (各模块职责、交互方式)。
        - 数据流说明。
        - 状态管理策略。
      - **`docs/04-modules/`:** (每个核心模块一个 .md 文件)
        - `character-module.md`: 角色卡模块设计、核心组件 API (props, events, slots)、composables 用法、数据结构。
        - `world-module.md`: 世界书模块详解。
        - `toolbox-module.md`: 工具箱模块详解。
        - `core-module.md`: 核心/共享模块组件和工具函数说明。
      - **`docs/05-coding-standards.md`:** 编码规范、命名约定、注释规范。
      - **`docs/06-contribution-guide.md`:** 分支策略、代码提交流程、Code Review 指南。
      - **`docs/07-deployment.md`:** (如果涉及 Electron 打包部署的特殊说明)
      - **`docs/08-faq.md`:** 常见问题与解答。
    - **产出：** 完整的中文开发文档。

**阶段四：测试、审查与优化 (贯穿始终，并在最后集中进行，预计 1-2 周)**

1.  **1. 补充和完善测试用例：**

    - **任务：** 为核心模块、重要组件、关键逻辑编写单元测试和组件测试。
    - **目标：** 保证重构后代码的质量和稳定性。
    - **方法：** 使用 Vitest 等测试框架。
    - **产出：** 达到预定测试覆盖率的测试套件。

2.  **2. 进行全面的代码审查 (Code Review)：**

    - **任务：** 团队成员交叉审查重构后的代码和新编写的文档。
    - **目标：** 发现潜在问题，统一认知，提升代码质量。
    - **产出：** Code Review 记录和修改后的代码/文档。

3.  **3. 性能评估与优化：**

    - **任务：** 检查重构是否引入性能瓶颈，并进行优化。
    - **目标：** 确保应用性能不下降，甚至有所提升。
    - **方法：** 使用浏览器开发者工具进行性能分析。
    - **产出：** 性能分析报告和必要的优化。

4.  **4. 用户验收测试 (UAT)：**
    - **任务：** 模拟最终用户场景，对所有功能进行测试。
    - **目标：** 确保重构后的项目满足所有需求且无重大缺陷。
    - **产出：** UAT 测试报告。

**四、风险管理与应对**

- **风险 1：时间预估不足。**
  - **应对：** 将任务进一步细化，里程碑设置更频繁，及时调整计划。优先重构核心痛点模块。
- **风险 2：重构引入新的 Bug。**
  - **应对：** 严格执行测试流程，加强 Code Review，小步快跑，及时修复。
- **风险 3：团队成员对新架构和规范的学习成本。**
  - **应对：** 提供清晰的文档和必要的培训，鼓励交流和提问。
- **风险 4：重构过程中需求变更。**
  - **应对：** 尽量在重构期间冻结大的需求变更，或将其纳入后续迭代。

**五、衡量指标**

- **代码复用率：** 通过工具（如 SonarQube 或静态分析）或人工评估重复代码的减少程度。
- **模块内聚性与模块间耦合度：** 定性评估，或通过依赖分析工具辅助。
- **代码复杂度：** 单个函数/组件的圈复杂度等指标。
- **文档完善度：** 评估文档是否覆盖所有必要方面，是否清晰易懂。
- **Bug 数量：** 重构后一段时间内，新增 Bug 的趋势。
- **开发效率：** 团队成员对新架构下开发新功能或修改现有功能的效率反馈。

这个计划比较详尽，您可以根据项目的具体情况和团队资源进行调整。最重要的是，保持耐心，持续改进。祝您重构顺利！
